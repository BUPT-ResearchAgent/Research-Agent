<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ç”Ÿç«¯æ¶ˆæ¯åŠŸèƒ½æµ‹è¯• - ä¿®å¤å</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #console-log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-card">
        <h1 class="test-title">å­¦ç”Ÿç«¯æ¶ˆæ¯åŠŸèƒ½ - ä¿®å¤éªŒè¯</h1>
        <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•ä¿®å¤åçš„å­¦ç”Ÿç«¯æ¶ˆæ¯åŠŸèƒ½ã€‚ä¸»è¦ä¿®å¤ï¼šmessaging-functions.jsä¸­ä½¿ç”¨userIdè€Œä¸æ˜¯studentIdã€‚</p>
    </div>

    <div class="test-card">
        <h2 class="test-title">1. è®¤è¯çŠ¶æ€æ£€æŸ¥</h2>
        <button onclick="testAuth()">æ£€æŸ¥è®¤è¯çŠ¶æ€</button>
        <div id="auth-result"></div>
    </div>

    <div class="test-card">
        <h2 class="test-title">2. ç”¨æˆ·ä¿¡æ¯è·å–æµ‹è¯•</h2>
        <button onclick="testGetCurrentUserInfo()">æµ‹è¯• getCurrentUserInfo()</button>
        <div id="userinfo-result"></div>
    </div>

    <div class="test-card">
        <h2 class="test-title">3. è¯¾ç¨‹åˆ—è¡¨APIæµ‹è¯•</h2>
        <button onclick="testCourseAPI()">æµ‹è¯•è¯¾ç¨‹åˆ—è¡¨API</button>
        <div id="course-result"></div>
    </div>

    <div class="test-card">
        <h2 class="test-title">4. å®Œæ•´æ¶ˆæ¯åŠŸèƒ½æµ‹è¯•</h2>
        <button onclick="testFullMessaging()">æµ‹è¯•å®Œæ•´æ¶ˆæ¯åŠŸèƒ½</button>
        <div id="messaging-result"></div>
    </div>

    <div class="test-card">
        <h2 class="test-title">è°ƒè¯•æ—¥å¿—</h2>
        <div id="console-log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        // é‡å†™console.logæ¥æ˜¾ç¤ºåœ¨é¡µé¢ä¸Š
        const originalLog = console.log;
        const originalError = console.error;
        const logDiv = document.getElementById('console-log');
        
        function addLog(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#dc3545' : type === 'warn' ? '#ffc107' : '#333';
            logDiv.innerHTML += `<div style="color: ${color}; margin: 2px 0;">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog(args.join(' '), 'error');
        };
        
        function clearLog() {
            logDiv.innerHTML = '';
        }
        
        // æ¨¡æ‹Ÿå­¦ç”Ÿç”¨æˆ·ç™»å½•çŠ¶æ€
        window.currentUser = {
            id: 5,
            userId: 5,
            username: 'student2',
            realName: 'å­¦ç”Ÿ2',
            role: 'student'
        };
        
        console.log('æµ‹è¯•é¡µé¢åˆå§‹åŒ–å®Œæˆ, æ¨¡æ‹Ÿç”¨æˆ·:', window.currentUser);

        async function testAuth() {
            const resultDiv = document.getElementById('auth-result');
            try {
                const response = await fetch('/api/auth/current-user', {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="test-result success">âœ… è®¤è¯æˆåŠŸ: ${JSON.stringify(result.data, null, 2)}</div>`;
                    // æ›´æ–°å…¨å±€ç”¨æˆ·ä¿¡æ¯
                    window.currentUser = result.data;
                    if (window.currentUser.id && !window.currentUser.userId) {
                        window.currentUser.userId = window.currentUser.id;
                    }
                } else {
                    resultDiv.innerHTML = `<div class="test-result error">âŒ è®¤è¯å¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        function testGetCurrentUserInfo() {
            const resultDiv = document.getElementById('userinfo-result');
            
            // ç¡®ä¿messaging-functions.jså·²åŠ è½½
            if (typeof getCurrentUserInfo === 'function') {
                try {
                    const userInfo = getCurrentUserInfo();
                    if (userInfo) {
                        resultDiv.innerHTML = `<div class="test-result success">âœ… getCurrentUserInfo() æˆåŠŸ: ${JSON.stringify(userInfo, null, 2)}</div>`;
                    } else {
                        resultDiv.innerHTML = `<div class="test-result error">âŒ getCurrentUserInfo() è¿”å› null</div>`;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<div class="test-result error">âŒ getCurrentUserInfo() é”™è¯¯: ${error.message}</div>`;
                }
            } else {
                resultDiv.innerHTML = `<div class="test-result error">âŒ getCurrentUserInfo() å‡½æ•°æœªæ‰¾åˆ°ï¼Œè¯·ç¡®ä¿messaging-functions.jså·²åŠ è½½</div>`;
            }
        }

        async function testCourseAPI() {
            const resultDiv = document.getElementById('course-result');
            
            // é¦–å…ˆè·å–ç”¨æˆ·ä¿¡æ¯
            const userInfo = getCurrentUserInfo ? getCurrentUserInfo() : null;
            if (!userInfo) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯</div>`;
                return;
            }
            
            try {
                const url = `/api/messages/user-courses?userId=${userInfo.userId}&userType=${userInfo.userType}`;
                console.log('æµ‹è¯•è¯¾ç¨‹API URL:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="test-result success">âœ… è¯¾ç¨‹APIæˆåŠŸ: æ‰¾åˆ° ${result.data.length} é—¨è¯¾ç¨‹<br>
                    <pre>${JSON.stringify(result.data, null, 2)}</pre></div>`;
                } else {
                    resultDiv.innerHTML = `<div class="test-result error">âŒ è¯¾ç¨‹APIå¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">âŒ è¯¾ç¨‹APIç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        async function testFullMessaging() {
            const resultDiv = document.getElementById('messaging-result');
            resultDiv.innerHTML = `<div class="test-result info">ğŸ”„ å¼€å§‹å®Œæ•´æ¶ˆæ¯åŠŸèƒ½æµ‹è¯•...</div>`;
            
            let testResults = [];
            
            // 1. æµ‹è¯•ç”¨æˆ·ä¿¡æ¯è·å–
            try {
                const userInfo = getCurrentUserInfo ? getCurrentUserInfo() : null;
                if (userInfo && userInfo.userId) {
                    testResults.push(`âœ… ç”¨æˆ·ä¿¡æ¯è·å–: ç”¨æˆ·ID ${userInfo.userId}`);
                } else {
                    testResults.push(`âŒ ç”¨æˆ·ä¿¡æ¯è·å–å¤±è´¥`);
                    resultDiv.innerHTML = `<div class="test-result error">${testResults.join('<br>')}</div>`;
                    return;
                }
                
                // 2. æµ‹è¯•è¯¾ç¨‹åˆ—è¡¨
                const courseResponse = await fetch(`/api/messages/user-courses?userId=${userInfo.userId}&userType=${userInfo.userType}`, {
                    credentials: 'include'
                });
                const courseResult = await courseResponse.json();
                
                if (courseResult.success && courseResult.data.length > 0) {
                    testResults.push(`âœ… è¯¾ç¨‹åˆ—è¡¨: æ‰¾åˆ° ${courseResult.data.length} é—¨è¯¾ç¨‹`);
                    
                    // 3. æµ‹è¯•ç¬¬ä¸€é—¨è¯¾ç¨‹çš„ç”¨æˆ·åˆ—è¡¨
                    const firstCourse = courseResult.data[0];
                    const usersResponse = await fetch(`/api/messages/course-users?courseId=${firstCourse.id}&userId=${userInfo.userId}&userType=${userInfo.userType}`, {
                        credentials: 'include'
                    });
                    const usersResult = await usersResponse.json();
                    
                    if (usersResult.success) {
                        testResults.push(`âœ… è¯¾ç¨‹ç”¨æˆ·åˆ—è¡¨: è¯¾ç¨‹"${firstCourse.name}"ä¸­æœ‰ ${usersResult.data.length} ä¸ªç”¨æˆ·`);
                        testResults.push(`ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼å­¦ç”Ÿç«¯æ¶ˆæ¯åŠŸèƒ½å·²æ­£å¸¸å·¥ä½œï¼`);
                    } else {
                        testResults.push(`âŒ è¯¾ç¨‹ç”¨æˆ·åˆ—è¡¨å¤±è´¥: ${usersResult.message}`);
                    }
                } else {
                    testResults.push(`âŒ è¯¾ç¨‹åˆ—è¡¨: ${courseResult.message || 'æ²¡æœ‰æ‰¾åˆ°è¯¾ç¨‹'}`);
                }
                
            } catch (error) {
                testResults.push(`âŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: ${error.message}`);
            }
            
            const resultClass = testResults.some(r => r.includes('âŒ')) ? 'error' : 'success';
            resultDiv.innerHTML = `<div class="test-result ${resultClass}">${testResults.join('<br>')}</div>`;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            setTimeout(() => {
                testAuth();
            }, 1000);
        });
    </script>
    
    <!-- åŠ è½½å¿…è¦çš„æ¶ˆæ¯åŠŸèƒ½æ–‡ä»¶ -->
    <script src="messaging-functions.js"></script>
</body>
</html> 