<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå­¦ä¹ åŠ©æ‰‹æµ‹è¯•é¡µé¢</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .chat-history {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            background: #fafafa;
            margin-bottom: 15px;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        #chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: none;
            font-size: 14px;
        }
        
        .send-btn {
            padding: 10px 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .send-btn:hover:not(:disabled) {
            background: #0056b3;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }
        
        .user-message {
            background: #e3f2fd;
            margin-left: 20px;
        }
        
        .ai-message {
            background: #f1f8e9;
            margin-right: 20px;
        }
        
        .system-message {
            background: #fff3e0;
            text-align: center;
            font-style: italic;
        }
        
        .status {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            text-align: center;
        }
        
        .status.ready {
            background: #d4edda;
            color: #155724;
        }
        
        .status.thinking {
            background: #fff3cd;
            color: #856404;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-robot"></i> AIå­¦ä¹ åŠ©æ‰‹æµ‹è¯•</h1>
        
        <div id="status" class="status ready">è¯·é€‰æ‹©è¯¾ç¨‹å¼€å§‹å¯¹è¯</div>
        
        <div class="form-group">
            <label for="helper-course-select">é€‰æ‹©è¯¾ç¨‹ <span style="color: red;">*</span></label>
            <select id="helper-course-select" class="form-select" onchange="onCourseChange()">
                <option value="">è¯·é€‰æ‹©è¯¾ç¨‹</option>
            </select>
        </div>
        
        <div id="chat-history" class="chat-history">
            <div class="chat-message system-message">
                <h4>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨AIå­¦ä¹ åŠ©æ‰‹ï¼</h4>
                <p>æˆ‘æ˜¯æ‚¨çš„ä¸“å±å­¦ä¹ ä¼™ä¼´ï¼Œå¯ä»¥å¸®åŠ©æ‚¨ï¼š</p>
                <ul style="text-align: left; display: inline-block;">
                    <li>ğŸ“š è§£ç­”è¯¾ç¨‹ç›¸å…³é—®é¢˜</li>
                    <li>ğŸ“– åˆ†æå­¦ä¹ èµ„æ–™å†…å®¹</li>
                    <li>ğŸ’¡ æä¾›å­¦ä¹ å»ºè®®å’ŒæŒ‡å¯¼</li>
                    <li>ğŸ” æ·±å…¥è§£é‡Šå¤æ‚æ¦‚å¿µ</li>
                </ul>
                <p>è¯·å…ˆé€‰æ‹©è¯¾ç¨‹ï¼Œç„¶åå¼€å§‹æé—®å§ï¼</p>
            </div>
        </div>
        
        <div class="chat-input-area">
            <textarea id="chat-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." rows="2" disabled></textarea>
            <button id="send-button" class="send-btn" onclick="sendMessage()" disabled>
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            ğŸ’¡ æç¤ºï¼šæŒ‰Enterå‘é€æ¶ˆæ¯ï¼ŒShift+Enteræ¢è¡Œ
        </div>
    </div>

    <script>
        let currentUser = null;
        let helperCourses = [];
        let isAIResponding = false;
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = async function() {
            await checkUserLogin();
            await loadCourses();
            setupChatInput();
        };
        
        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        async function checkUserLogin() {
            try {
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    currentUser = {
                        userId: result.data.id,
                        username: result.data.username,
                        role: result.data.role,
                        realName: result.data.realName
                    };
                    console.log('ç”¨æˆ·ç™»å½•çŠ¶æ€:', currentUser);
                } else {
                    updateStatus('error', 'ç”¨æˆ·æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
                    return false;
                }
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                updateStatus('error', 'æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥');
                return false;
            }
            return true;
        }
        
        // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
        async function loadCourses() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`/api/student/my-courses?userId=${currentUser.userId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    helperCourses = result.data || [];
                    updateCourseSelect();
                    console.log('è¯¾ç¨‹åˆ—è¡¨:', helperCourses);
                } else {
                    console.error('åŠ è½½è¯¾ç¨‹åˆ—è¡¨å¤±è´¥:', result.message);
                    updateStatus('error', 'åŠ è½½è¯¾ç¨‹åˆ—è¡¨å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                console.error('åŠ è½½è¯¾ç¨‹åˆ—è¡¨å¤±è´¥:', error);
                updateStatus('error', 'åŠ è½½è¯¾ç¨‹åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
        
        // æ›´æ–°è¯¾ç¨‹é€‰æ‹©ä¸‹æ‹‰æ¡†
        function updateCourseSelect() {
            const courseSelect = document.getElementById('helper-course-select');
            courseSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è¯¾ç¨‹</option>';
            
            helperCourses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.name} (${course.courseCode})`;
                courseSelect.appendChild(option);
            });
        }
        
        // è¯¾ç¨‹é€‰æ‹©å˜åŒ–äº‹ä»¶
        function onCourseChange() {
            const courseSelect = document.getElementById('helper-course-select');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            
            const courseId = courseSelect.value;
            
            if (courseId) {
                chatInput.disabled = false;
                sendButton.disabled = false;
                updateStatus('ready', 'å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹æé—®äº†');
                
                const selectedCourse = helperCourses.find(c => c.id == courseId);
                if (selectedCourse) {
                    addSystemMessage(`å·²é€‰æ‹©è¯¾ç¨‹ï¼š${selectedCourse.name} (${selectedCourse.courseCode})`);
                }
            } else {
                chatInput.disabled = true;
                sendButton.disabled = true;
                updateStatus('ready', 'è¯·é€‰æ‹©è¯¾ç¨‹');
            }
        }
        
        // è®¾ç½®èŠå¤©è¾“å…¥æ¡†
        function setupChatInput() {
            const chatInput = document.getElementById('chat-input');
            
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    if (e.shiftKey) {
                        return; // å…è®¸æ¢è¡Œ
                    } else {
                        e.preventDefault();
                        const message = this.value.trim();
                        if (message) {
                            sendMessage();
                        }
                    }
                }
            });
            
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });
        }
        
        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const courseSelect = document.getElementById('helper-course-select');
            
            const message = chatInput.value.trim();
            const courseId = courseSelect.value;
            
            if (!message) {
                alert('è¯·è¾“å…¥æ‚¨çš„é—®é¢˜');
                return;
            }
            
            if (!courseId) {
                alert('è¯·å…ˆé€‰æ‹©è¯¾ç¨‹');
                return;
            }
            
            if (!currentUser) {
                alert('ç”¨æˆ·ä¿¡æ¯ä¸å­˜åœ¨ï¼Œè¯·é‡æ–°ç™»å½•');
                return;
            }
            
            if (isAIResponding) {
                alert('AIæ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨å€™...');
                return;
            }
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addUserMessage(message);
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            chatInput.value = '';
            chatInput.style.height = 'auto';
            
            // æ˜¾ç¤ºAIæ­£åœ¨æ€è€ƒ
            updateStatus('thinking', 'AIæ­£åœ¨æ€è€ƒ...');
            isAIResponding = true;
            
            try {
                const response = await fetch('/api/student/learning-assistant/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        userId: currentUser.userId,
                        courseId: courseId,
                        question: message,
                        topK: 5
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.data) {
                    addAIMessage(result.data.answer);
                    updateStatus('ready', 'å‡†å¤‡å°±ç»ª');
                } else {
                    addAIMessage('æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”æ‚¨çš„é—®é¢˜ã€‚é”™è¯¯ä¿¡æ¯ï¼š' + result.message);
                    updateStatus('error', 'å“åº”å¤±è´¥');
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                addAIMessage('æŠ±æ­‰ï¼Œç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·ç¨åå†è¯•ã€‚');
                updateStatus('error', 'ç½‘ç»œé”™è¯¯');
            } finally {
                isAIResponding = false;
            }
        }
        
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
        function addUserMessage(message) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message user-message';
            messageDiv.innerHTML = `<strong>æ‚¨:</strong> ${message}`;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // æ·»åŠ AIæ¶ˆæ¯
        function addAIMessage(message) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message ai-message';
            messageDiv.innerHTML = `<strong>AIåŠ©æ‰‹:</strong> ${message}`;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(message) {
            const chatHistory = document.getElementById('chat-history');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message system-message';
            messageDiv.innerHTML = message;
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(type, message) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }
    </script>
</body>
</html>