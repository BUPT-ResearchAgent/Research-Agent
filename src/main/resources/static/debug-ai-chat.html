<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå­¦ä¹ åŠ©æ‰‹è¯Šæ–­å·¥å…·</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .diagnostic-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .result { margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .warning { background: #fff3e0; color: #f57c00; }
        .info { background: #e3f2fd; color: #1976d2; }
        button { margin: 5px; padding: 8px 16px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ AIå­¦ä¹ åŠ©æ‰‹è¯Šæ–­å·¥å…·</h1>
    <p>æ­¤å·¥å…·ç”¨äºè¯Šæ–­å­¦ç”Ÿç«¯AIå­¦ä¹ åŠ©æ‰‹å‘é€æŒ‰é’®æ— å“åº”çš„é—®é¢˜</p>
    
    <div class="diagnostic-section">
        <h3>1. ç”¨æˆ·ç™»å½•çŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkUserStatus()">æ£€æŸ¥ç”¨æˆ·çŠ¶æ€</button>
        <div id="user-status-result" class="result"></div>
    </div>
    
    <div class="diagnostic-section">
        <h3>2. é¡µé¢å…ƒç´ æ£€æŸ¥</h3>
        <button onclick="checkPageElements()">æ£€æŸ¥é¡µé¢å…ƒç´ </button>
        <div id="elements-result" class="result"></div>
    </div>
    
    <div class="diagnostic-section">
        <h3>3. è¯¾ç¨‹æ•°æ®æ£€æŸ¥</h3>
        <button onclick="checkCourseData()">æ£€æŸ¥è¯¾ç¨‹æ•°æ®</button>
        <div id="course-data-result" class="result"></div>
    </div>
    
    <div class="diagnostic-section">
        <h3>4. APIç«¯ç‚¹æµ‹è¯•</h3>
        <button onclick="testAPIEndpoints()">æµ‹è¯•APIç«¯ç‚¹</button>
        <div id="api-test-result" class="result"></div>
    </div>
    
    <div class="diagnostic-section">
        <h3>5. å‘é€æŒ‰é’®çŠ¶æ€æ£€æŸ¥</h3>
        <button onclick="checkSendButtonStatus()">æ£€æŸ¥å‘é€æŒ‰é’®</button>
        <div id="send-button-result" class="result"></div>
    </div>
    
    <div class="diagnostic-section">
        <h3>6. æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯</h3>
        <input type="text" id="test-message" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯" value="ä½ å¥½ï¼ŒAIåŠ©æ‰‹">
        <button onclick="simulateSendMessage()">æ¨¡æ‹Ÿå‘é€</button>
        <div id="simulate-result" class="result"></div>
    </div>

    <script>
        // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        async function checkUserStatus() {
            const resultDiv = document.getElementById('user-status-result');
            try {
                const response = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>âœ… ç”¨æˆ·å·²ç™»å½•</strong><br>
                        ç”¨æˆ·ID: ${result.data.id}<br>
                        ç”¨æˆ·å: ${result.data.username}<br>
                        è§’è‰²: ${result.data.role}<br>
                        çœŸå®å§“å: ${result.data.realName || 'N/A'}
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ ç”¨æˆ·æœªç™»å½•: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æ£€æŸ¥ç”¨æˆ·çŠ¶æ€å¤±è´¥: ${error.message}`;
            }
        }
        
        // æ£€æŸ¥é¡µé¢å…ƒç´ 
        function checkPageElements() {
            const resultDiv = document.getElementById('elements-result');
            const elements = [
                'helper-course-select',
                'chat-input', 
                'send-button',
                'chat-history'
            ];
            
            let results = [];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    results.push(`âœ… ${id}: å­˜åœ¨`);
                    if (element.disabled !== undefined) {
                        results.push(`   - disabled: ${element.disabled}`);
                    }
                } else {
                    results.push(`âŒ ${id}: ä¸å­˜åœ¨`);
                }
            });
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = results.join('<br>');
        }
        
        // æ£€æŸ¥è¯¾ç¨‹æ•°æ®
        async function checkCourseData() {
            const resultDiv = document.getElementById('course-data-result');
            try {
                // é¦–å…ˆæ£€æŸ¥ç”¨æˆ·çŠ¶æ€
                const authResponse = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                const authResult = await authResponse.json();
                
                if (!authResult.success) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = 'âŒ ç”¨æˆ·æœªç™»å½•ï¼Œæ— æ³•è·å–è¯¾ç¨‹æ•°æ®';
                    return;
                }
                
                const userId = authResult.data.id;
                const response = await fetch(`/api/student/my-courses?userId=${userId}`, {
                    method: 'GET',
                    credentials: 'include'
                });
                const result = await response.json();
                
                if (result.success) {
                    const courses = result.data || [];
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>âœ… è¯¾ç¨‹æ•°æ®è·å–æˆåŠŸ</strong><br>
                        è¯¾ç¨‹æ•°é‡: ${courses.length}<br>
                        ${courses.length > 0 ? 
                            'è¯¾ç¨‹åˆ—è¡¨:<br>' + courses.map(c => `- ${c.name} (ID: ${c.id})`).join('<br>') :
                            'âš ï¸ æ²¡æœ‰å¯ç”¨è¯¾ç¨‹'
                        }
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ è·å–è¯¾ç¨‹æ•°æ®å¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æ£€æŸ¥è¯¾ç¨‹æ•°æ®å¤±è´¥: ${error.message}`;
            }
        }
        
        // æµ‹è¯•APIç«¯ç‚¹
        async function testAPIEndpoints() {
            const resultDiv = document.getElementById('api-test-result');
            const endpoints = [
                { url: '/api/auth/check', method: 'GET', name: 'ç”¨æˆ·è®¤è¯' },
                { url: '/api/student/my-courses?userId=1', method: 'GET', name: 'æˆ‘çš„è¯¾ç¨‹' }
            ];
            
            let results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint.url, {
                        method: endpoint.method,
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        results.push(`âœ… ${endpoint.name}: å“åº”æ­£å¸¸ (${response.status})`);
                    } else {
                        results.push(`âš ï¸ ${endpoint.name}: HTTP ${response.status}`);
                    }
                } catch (error) {
                    results.push(`âŒ ${endpoint.name}: ${error.message}`);
                }
            }
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = results.join('<br>');
        }
        
        // æ£€æŸ¥å‘é€æŒ‰é’®çŠ¶æ€
        function checkSendButtonStatus() {
            const resultDiv = document.getElementById('send-button-result');
            const sendButton = document.getElementById('send-button');
            const chatInput = document.getElementById('chat-input');
            const courseSelect = document.getElementById('helper-course-select');
            
            let results = [];
            
            if (sendButton) {
                results.push(`âœ… å‘é€æŒ‰é’®å­˜åœ¨`);
                results.push(`   - disabled: ${sendButton.disabled}`);
                results.push(`   - onclick: ${sendButton.onclick ? 'å·²ç»‘å®š' : 'æœªç»‘å®š'}`);
            } else {
                results.push(`âŒ å‘é€æŒ‰é’®ä¸å­˜åœ¨`);
            }
            
            if (chatInput) {
                results.push(`âœ… è¾“å…¥æ¡†å­˜åœ¨`);
                results.push(`   - disabled: ${chatInput.disabled}`);
                results.push(`   - value: "${chatInput.value}"`);
            } else {
                results.push(`âŒ è¾“å…¥æ¡†ä¸å­˜åœ¨`);
            }
            
            if (courseSelect) {
                results.push(`âœ… è¯¾ç¨‹é€‰æ‹©æ¡†å­˜åœ¨`);
                results.push(`   - value: "${courseSelect.value}"`);
                results.push(`   - options: ${courseSelect.options.length}`);
            } else {
                results.push(`âŒ è¯¾ç¨‹é€‰æ‹©æ¡†ä¸å­˜åœ¨`);
            }
            
            resultDiv.className = 'result info';
            resultDiv.innerHTML = results.join('<br>');
        }
        
        // æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯
        async function simulateSendMessage() {
            const resultDiv = document.getElementById('simulate-result');
            const testMessage = document.getElementById('test-message').value;
            
            if (!testMessage.trim()) {
                resultDiv.className = 'result warning';
                resultDiv.innerHTML = 'âš ï¸ è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯';
                return;
            }
            
            try {
                // æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
                const authResponse = await fetch('/api/auth/check', {
                    method: 'GET',
                    credentials: 'include'
                });
                const authResult = await authResponse.json();
                
                if (!authResult.success) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = 'âŒ ç”¨æˆ·æœªç™»å½•';
                    return;
                }
                
                const userId = authResult.data.id;
                
                // æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯åˆ°AIåŠ©æ‰‹
                const response = await fetch('/api/student/learning-assistant/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        userId: userId,
                        courseId: 1, // ä½¿ç”¨æµ‹è¯•è¯¾ç¨‹ID
                        question: testMessage,
                        topK: 5
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        <strong>âœ… æ¶ˆæ¯å‘é€æˆåŠŸ</strong><br>
                        AIå›å¤: ${result.data.answer || 'æ— å›å¤å†…å®¹'}
                    `;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ${result.message}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `âŒ æ¨¡æ‹Ÿå‘é€å¤±è´¥: ${error.message}`;
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.onload = function() {
            checkUserStatus();
            checkPageElements();
        };
    </script>
</body>
</html>