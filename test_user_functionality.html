<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户功能测试</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .test-button { background: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>SmartEdu 用户功能测试</h1>
    
    <div class="test-section">
        <h3>1. 检查应用程序状态</h3>
        <button class="test-button" onclick="checkAppStatus()">检查应用状态</button>
        <div id="app-status-result"></div>
    </div>
    
    <div class="test-section">
        <h3>2. 测试教师注册</h3>
        <button class="test-button" onclick="testTeacherRegister()">测试教师注册</button>
        <div id="teacher-register-result"></div>
    </div>
    
    <div class="test-section">
        <h3>3. 测试学生注册</h3>
        <button class="test-button" onclick="testStudentRegister()">测试学生注册</button>
        <div id="student-register-result"></div>
    </div>
    
    <div class="test-section">
        <h3>4. 测试用户登录</h3>
        <button class="test-button" onclick="testLogin()">测试用户登录</button>
        <div id="login-result"></div>
    </div>
    
    <div class="test-section">
        <h3>5. 测试管理端创建用户</h3>
        <button class="test-button" onclick="testAdminCreateUser()">管理员登录并创建用户</button>
        <div id="admin-create-result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }
        
        async function checkAppStatus() {
            try {
                const response = await fetch(`${API_BASE}/auth/check`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showResult('app-status-result', '✅ 应用程序运行正常', 'success');
                } else {
                    showResult('app-status-result', '⚠️ 应用程序响应异常', 'error');
                }
            } catch (error) {
                showResult('app-status-result', `❌ 应用程序无法连接: ${error.message}`, 'error');
            }
        }
        
        async function testTeacherRegister() {
            const username = `teacher_test_${Date.now()}`;
            const password = 'test123';
            
            try {
                const response = await fetch(`${API_BASE}/auth/register/teacher`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        realName: '测试教师',
                        email: 'teacher@test.com',
                        phone: '13800138000',
                        teacherCode: `T${Date.now()}`,
                        department: '计算机学院',
                        title: '讲师'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('teacher-register-result', `✅ 教师注册成功: ${username}`, 'success');
                    // 保存用户名用于后续登录测试
                    window.testTeacherUsername = username;
                    window.testTeacherPassword = password;
                } else {
                    showResult('teacher-register-result', `❌ 教师注册失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('teacher-register-result', `❌ 教师注册错误: ${error.message}`, 'error');
            }
        }
        
        async function testStudentRegister() {
            const username = `student_test_${Date.now()}`;
            const password = 'test123';
            
            try {
                const response = await fetch(`${API_BASE}/auth/register/student`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        realName: '测试学生',
                        email: 'student@test.com',
                        phone: '13800138001',
                        studentId: `S${Date.now()}`,
                        className: '测试班级',
                        major: '计算机科学',
                        grade: '2024级',
                        entranceYear: 2024
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResult('student-register-result', `✅ 学生注册成功: ${username}`, 'success');
                    // 保存用户名用于后续登录测试
                    window.testStudentUsername = username;
                    window.testStudentPassword = password;
                } else {
                    showResult('student-register-result', `❌ 学生注册失败: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('student-register-result', `❌ 学生注册错误: ${error.message}`, 'error');
            }
        }
        
        async function testLogin() {
            const testCases = [
                { username: window.testTeacherUsername, password: window.testTeacherPassword, role: 'teacher' },
                { username: window.testStudentUsername, password: window.testStudentPassword, role: 'student' }
            ];
            
            let results = [];
            
            for (const testCase of testCases) {
                if (!testCase.username) continue;
                
                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify(testCase)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        results.push(`✅ ${testCase.role}登录成功: ${testCase.username}`);
                    } else {
                        results.push(`❌ ${testCase.role}登录失败: ${result.message}`);
                    }
                } catch (error) {
                    results.push(`❌ ${testCase.role}登录错误: ${error.message}`);
                }
            }
            
            const resultHtml = results.length > 0 ? results.join('<br>') : '⚠️ 请先运行注册测试';
            showResult('login-result', resultHtml, results.every(r => r.includes('✅')) ? 'success' : 'error');
        }
        
        async function testAdminCreateUser() {
            try {
                // 先登录管理员
                const loginResponse = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123',
                        role: 'admin'
                    })
                });
                
                const loginResult = await loginResponse.json();
                
                if (!loginResult.success) {
                    showResult('admin-create-result', `❌ 管理员登录失败: ${loginResult.message}`, 'error');
                    return;
                }
                
                // 创建测试用户
                const username = `admin_created_${Date.now()}`;
                const createResponse = await fetch(`${API_BASE}/auth/admin/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        username: username,
                        password: 'test123',
                        role: 'teacher'
                    })
                });
                
                const createResult = await createResponse.json();
                
                if (createResult.success) {
                    // 测试新创建的用户是否能登录
                    const testLoginResponse = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            username: username,
                            password: 'test123',
                            role: 'teacher'
                        })
                    });
                    
                    const testLoginResult = await testLoginResponse.json();
                    
                    if (testLoginResult.success) {
                        showResult('admin-create-result', `✅ 管理端创建用户成功且可以登录: ${username}`, 'success');
                    } else {
                        showResult('admin-create-result', `⚠️ 管理端创建用户成功但无法登录: ${testLoginResult.message}`, 'error');
                    }
                } else {
                    showResult('admin-create-result', `❌ 管理端创建用户失败: ${createResult.message}`, 'error');
                }
                
            } catch (error) {
                showResult('admin-create-result', `❌ 管理端测试错误: ${error.message}`, 'error');
            }
        }
        
        // 页面加载时自动检查应用状态
        window.addEventListener('load', checkAppStatus);
    </script>
</body>
</html> 